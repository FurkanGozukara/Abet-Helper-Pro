{% extends 'base.html' %}

{% block title %}Program Outcome Scores - {{ course.code }} - Accredit Calculator{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('course.course_detail', course_id=course.id) }}">{{ course.code }}</a></li>
<li class="breadcrumb-item active">Program Outcome Scores</li>
{% endblock %}

{% block styles %}
<style>
    .sortable {
        cursor: pointer;
        user-select: none;
    }
    
    .sortable:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }
    
    .fa-sort-up, .fa-sort-down {
        color: #0d6efd;
    }
    
    /* Styling for the sorting buttons */
    .sort-btn {
        position: relative;
        transition: all 0.2s;
        border-width: 2px;
    }
    
    .sort-btn.active {
        background-color: #0d6efd;
        color: white;
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    
    .sort-btn:hover:not(.active) {
        background-color: #f8f9fa;
        transform: translateY(-2px);
    }
    
    .sort-btn .fas {
        color: #0d6efd;
    }
    
    .sort-btn.active .fas {
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Debug Information - Only visible when ?debug=1 is in URL -->
    {% if request.args.get('debug') == '1' %}
    <div class="alert alert-info mb-4">
        <h4>Debug Information</h4>
        <ul>
            <li>Course: {{ course.code }} (ID: {{ course.id }})</li>
            <li>Exams: {{ exams|length }}</li>
            <li>Course Outcomes: {{ course_outcomes|length }}</li>
            <li>Program Outcomes: {{ program_outcomes|length }}</li>
            <li>Students: {{ students|length }}</li>
            <li>Student Results: {{ student_results|length }}</li>
            <li>Course Outcome Results: {{ course_outcome_results|length }}</li>
            <li>Program Outcome Results: {{ program_outcome_results|length }}</li>
            <li>has_course_outcomes: {{ has_course_outcomes }}</li>
            <li>has_exam_questions: {{ has_exam_questions }}</li>
            <li>has_student_scores: {{ has_student_scores }}</li>
            <li>has_valid_weights: {{ has_valid_weights }}</li>
        </ul>
        <!-- Show actual values for a sample -->
        {% if program_outcome_results %}
        <h5>Sample Program Outcome Result</h5>
        {% for code, data in program_outcome_results.items() %}
            {% if loop.first %}
            <pre>{{ code }}: {{ data }}</pre>
            {% endif %}
        {% endfor %}
        {% endif %}
    </div>
    {% endif %}

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Program Outcome Scores for {{ course.code }}: {{ course.name }}</h1>
        <div>
            <button type="button" class="btn btn-outline-success me-2" onclick="exportResults()">
                <i class="fas fa-file-export"></i> Export Results
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="exportStudentResults()">
                <i class="fas fa-file-export"></i> Export Student Results
            </button>
            <a href="{{ url_for('course.course_detail', course_id=course.id) }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Course
            </a>
        </div>
    </div>
    
    {% if not has_course_outcomes %}
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i> No course outcomes have been defined for this course.
            <a href="{{ url_for('outcome.add_course_outcome', course_id=course.id) }}" class="alert-link">Add course outcomes</a> to proceed.
        </div>
    {% elif not has_exam_questions %}
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i> No exam questions have been associated with course outcomes.
            {% if exams and exams|length > 0 %}
                <a href="{{ url_for('exam.exam_detail', exam_id=exams[0].id) }}" class="alert-link">Add questions to exams</a> and associate them with course outcomes.
            {% else %}
                <a href="{{ url_for('exam.add_exam', course_id=course.id) }}" class="alert-link">Create an exam</a> first, then add questions and associate them with course outcomes.
            {% endif %}
        </div>
    {% elif not has_student_scores %}
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i> No student scores have been entered for the exams.
            {% if exams and exams|length > 0 %}
                <a href="{{ url_for('student.manage_scores', exam_id=exams[0].id) }}" class="alert-link">Enter student scores</a> to calculate outcomes.
            {% else %}
                <a href="{{ url_for('exam.add_exam', course_id=course.id) }}" class="alert-link">Create an exam</a> first, then enter student scores.
            {% endif %}
        </div>
    {% else %}
        {% if total_weight_percent != 100 %}
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i> Your current exam weights total {{ total_weight_percent|round(1) }}% instead of 100%. 
            <a href="{{ url_for('exam.manage_weights', course_id=course.id) }}" class="alert-link">Adjust exam weights</a> for best accuracy.
        </div>
        {% endif %}
        <!-- Results Tabs -->
        <ul class="nav nav-tabs mb-4" id="resultsTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="program-outcomes-tab" data-bs-toggle="tab" 
                        data-bs-target="#program-outcomes" type="button" role="tab" 
                        aria-controls="program-outcomes" aria-selected="true">
                    Program Outcomes
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="course-outcomes-tab" data-bs-toggle="tab" 
                        data-bs-target="#course-outcomes" type="button" role="tab" 
                        aria-controls="course-outcomes" aria-selected="false">
                    Course Outcomes
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="student-results-tab" data-bs-toggle="tab" 
                        data-bs-target="#student-results" type="button" role="tab" 
                        aria-controls="student-results" aria-selected="false">
                    Student Results
                </button>
            </li>
        </ul>
        
        <div class="tab-content" id="resultsTabContent">
            <!-- Program Outcomes Tab -->
            <div class="tab-pane fade show active" id="program-outcomes" role="tabpanel" aria-labelledby="program-outcomes-tab">
                <div class="card">
                    <div class="card-header bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Program Outcome Achievement</h5>
                            <a href="{{ url_for('calculation.manage_achievement_levels', course_id=course.id) }}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-cog"></i> Configure Achievement Levels
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <canvas id="programOutcomesChart"></canvas>
                            </div>
                            <div class="col-md-4">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle"></i> Achievement Levels</h6>
                                    <div class="mt-2">
                                        {% for level in achievement_levels %}
                                            <div class="d-flex align-items-center mb-1">
                                                <div class="badge bg-{{ level.color }} me-2" style="width: 20px; height: 20px;"></div>
                                                <span>{{ level.name }} ({{ level.min_score }}% - {{ level.max_score }}%)</span>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Program Outcome</th>
                                        <th>Description</th>
                                        <th>Achievement Level</th>
                                        <th>Related Course Outcomes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for po_code, po_data in program_outcome_results.items() %}
                                        <tr>
                                            <td><strong>{{ po_code }}</strong></td>
                                            <td>{{ po_data.description|truncate(120) }}</td>
                                            <td>
                                                <div class="progress" style="height: 25px;">
                                                    {% if po_data.contributes %}
                                                    <div class="progress-bar bg-{{ 
                                                        (get_achievement_level(po_data.percentage, achievement_levels))['color'] 
                                                    }}" 
                                                         role="progressbar" 
                                                         style="width: {{ po_data.percentage }}%;" 
                                                         aria-valuenow="{{ po_data.percentage }}" 
                                                         aria-valuemin="0" 
                                                         aria-valuemax="100">
                                                        {{ "%.1f"|format(po_data.percentage) }}% ({{ 
                                                            (get_achievement_level(po_data.percentage, achievement_levels))['name'] 
                                                        }})
                                                    </div>
                                                    {% else %}
                                                    <div class="text-center text-muted">NA</div>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td>
                                                {% for co_code in po_data.course_outcomes %}
                                                    <span class="badge bg-info">{{ co_code }}</span>
                                                {% else %}
                                                    <span class="text-muted">None</span>
                                                {% endfor %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Course Outcomes Tab -->
            <div class="tab-pane fade" id="course-outcomes" role="tabpanel" aria-labelledby="course-outcomes-tab">
                <div class="card">
                    <div class="card-header bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Course Outcome Achievement</h5>
                            <a href="{{ url_for('calculation.manage_achievement_levels', course_id=course.id) }}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-cog"></i> Configure Achievement Levels
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <canvas id="courseOutcomesChart"></canvas>
                            </div>
                            <div class="col-md-4">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle"></i> How Course Outcomes Are Calculated</h6>
                                    <p class="mb-0">Each course outcome's achievement is calculated based on student performance on questions associated with that outcome across all exams, weighted by the exam weights.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Course Outcome</th>
                                        <th>Description</th>
                                        <th>Achievement Level</th>
                                        <th>Related Program Outcomes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for co_code, co_data in course_outcome_results.items() %}
                                        <tr>
                                            <td><strong>{{ co_code }}</strong></td>
                                            <td>{{ co_data.description|truncate(120) }}</td>
                                            <td>
                                                <div class="progress" style="height: 25px;">
                                                    <div class="progress-bar bg-{{ 
                                                        (get_achievement_level(co_data.percentage, achievement_levels))['color'] 
                                                    }}" 
                                                         role="progressbar" 
                                                         style="width: {{ co_data.percentage }}%;" 
                                                         aria-valuenow="{{ co_data.percentage }}" 
                                                         aria-valuemin="0" 
                                                         aria-valuemax="100">
                                                        {{ "%.1f"|format(co_data.percentage) }}% ({{ 
                                                            (get_achievement_level(co_data.percentage, achievement_levels))['name'] 
                                                        }})
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                {% for po_code in co_data.program_outcomes %}
                                                    <span class="badge bg-primary">{{ po_code }}</span>
                                                {% else %}
                                                    <span class="text-muted">None</span>
                                                {% endfor %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Student Results Tab -->
            <div class="tab-pane fade" id="student-results" role="tabpanel" aria-labelledby="student-results-tab">
                <div class="card">
                    <div class="card-header bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Student Achievement Data</h5>
                            <div class="input-group" style="max-width: 300px;">
                                <input type="text" class="form-control" id="studentSearch" 
                                       placeholder="Search students..." aria-label="Search">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body" id="studentAchievementDataSection">
                        <div class="mb-3">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" id="studentSearch" 
                                       placeholder="Search students by ID or name...">
                            </div>
                        </div>
                        
                        <!-- Sorting Control Panel -->
                        <div class="card mb-3 bg-light">
                            <div class="card-body py-2">
                                <div class="d-flex align-items-center">
                                    <label class="me-2 fw-bold mb-0">
                                        <i class="fas fa-sort me-1"></i> Sort By:
                                    </label>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-outline-primary sort-btn" data-sort="student_id" data-direction="asc">
                                            Student ID <i class="fas fa-sort-up ms-1"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-primary sort-btn" data-sort="student_id" data-direction="desc">
                                            Student ID <i class="fas fa-sort-down ms-1"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-primary sort-btn" data-sort="name" data-direction="asc">
                                            Name <i class="fas fa-sort-up ms-1"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-primary sort-btn" data-sort="name" data-direction="desc">
                                            Name <i class="fas fa-sort-down ms-1"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-primary sort-btn" data-sort="overall_score" data-direction="asc">
                                            Score <i class="fas fa-sort-up ms-1"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-primary sort-btn" data-sort="overall_score" data-direction="desc">
                                            Score <i class="fas fa-sort-down ms-1"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="studentResultsTable">
                                <thead class="thead-light">
                                    <tr>
                                        <th class="sortable" data-sort="student_id">
                                            Student ID <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        <th class="sortable" data-sort="name">
                                            Name <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        <th class="sortable" data-sort="overall_score">
                                            Overall Score <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        <th>Course Outcomes Achievement</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for student_id, student_data in student_results.items() %}
                                        <tr>
                                            <td>{{ student_data.student_id }}</td>
                                            <td>
                                                {{ student_data.name }}
                                                {% if student_data.excluded is defined and student_data.excluded %}
                                                <span class="badge bg-danger rounded-pill">
                                                    <i class="fas fa-ban me-1"></i>Excluded from Calculations
                                                </span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if student_data.missing_mandatory is defined and student_data.missing_mandatory %}
                                                    <div class="alert alert-danger p-2 mb-0 d-flex align-items-center">
                                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                                        <span>
                                                            {% if student_data.excluded %}
                                                            <strong>Manually Excluded</strong>
                                                            <small class="d-block text-muted">
                                                                <i class="fas fa-info-circle me-1"></i>Score calculations may be inaccurate
                                                            </small>
                                                            {% else %}
                                                            <strong>Missed Mandatory Exam</strong>
                                                            {% endif %}
                                                        </span>
                                                    </div>
                                                {% else %}
                                                <div class="progress" style="height: 25px;">
                                                    <div class="progress-bar bg-{{ 
                                                        (get_achievement_level(student_data.overall_percentage, achievement_levels))['color'] 
                                                    }}" 
                                                         role="progressbar" 
                                                         style="width: {{ student_data.overall_percentage }}%;" 
                                                         aria-valuenow="{{ student_data.overall_percentage }}" 
                                                         aria-valuemin="0" 
                                                         aria-valuemax="100">
                                                        {{ "%.1f"|format(student_data.overall_percentage) }}% ({{ 
                                                            (get_achievement_level(student_data.overall_percentage, achievement_levels))['name'] 
                                                        }})
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-info" type="button" 
                                                        data-bs-toggle="collapse" 
                                                        data-bs-target="#student{{ student_id }}Details" 
                                                        aria-expanded="false" 
                                                        aria-controls="student{{ student_id }}Details">
                                                    Show Details
                                                </button>
                                                {% if not student_data.excluded %}
                                                <button type="button" class="btn btn-sm btn-outline-warning exclude-btn"
                                                        data-student-id="{{ student_id }}"
                                                        data-toggle-url="{{ url_for('student.toggle_exclusion', student_id=student_id) }}"
                                                        data-student-name="{{ student_data.name }}"
                                                        data-student-id-text="{{ student_data.student_id }}">
                                                    <i class="bi bi-dash-circle"></i> Exclude
                                                </button>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr class="collapse" id="student{{ student_id }}Details">
                                            <td colspan="4" class="p-0">
                                                <div class="p-3 bg-light">
                                                    <h6>Course Outcome Achievement for {{ student_data.name }}</h6>
                                                    <div class="row">
                                                        {% for co_code, percentage in student_data.course_outcomes.items() %}
                                                            <div class="col-md-6 mb-2">
                                                                <small><strong>{{ co_code }}:</strong></small>
                                                                <div class="progress" style="height: 15px;">
                                                                    <div class="progress-bar bg-{{ 
                                                                        (get_achievement_level(percentage, achievement_levels))['color'] 
                                                                    }}" 
                                                                         role="progressbar" 
                                                                         style="width: {{ percentage }}%;" 
                                                                         aria-valuenow="{{ percentage }}" 
                                                                         aria-valuemin="0" 
                                                                         aria-valuemax="100">
                                                                        {{ "%.1f"|format(percentage) }}%
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                    
                                                    <h6 class="mt-3">Exam Scores</h6>
                                                    <div class="row">
                                                        {% for exam_name, percentage in student_data.exam_scores.items() %}
                                                            <div class="col-md-6 mb-2">
                                                                <small><strong>{{ exam_name }}:</strong></small>
                                                                <div class="progress" style="height: 15px;">
                                                                    <div class="progress-bar bg-{{ 
                                                                        (get_achievement_level(percentage, achievement_levels))['color'] 
                                                                    }}" 
                                                                         role="progressbar" 
                                                                         style="width: {{ percentage }}%;" 
                                                                         aria-valuenow="{{ percentage }}" 
                                                                         aria-valuemin="0" 
                                                                         aria-valuemax="100">
                                                                        {{ "%.1f"|format(percentage) }}%
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Manually Excluded Students Section -->
                <div class="card mt-4">
                    <div class="card-header bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-ban text-danger me-2"></i>Manually Excluded Students
                            </h5>
                            <span class="badge bg-warning text-dark">
                                <i class="fas fa-exclamation-circle me-1"></i>These students' scores are not included in calculations
                            </span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Note:</strong> Excluded students are treated as if they failed to enter both mandatory and makeup exams.
                            Their scores do not impact Program Outcome calculations.
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="excludedStudentsTable">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Student ID</th>
                                        <th>Name</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% set has_excluded = false %}
                                    {% for student_id, student_data in student_results.items() %}
                                        {% if student_data.excluded is defined and student_data.excluded %}
                                            {% set has_excluded = true %}
                                            <tr>
                                                <td>{{ student_data.student_id }}</td>
                                                <td>{{ student_data.name }}</td>
                                                <td>
                                                    <form method="post" action="{{ url_for('student.toggle_exclusion', student_id=student_id) }}" class="d-inline include-form">
                                                        <button type="submit" class="btn btn-sm btn-success include-btn">
                                                            <i class="bi bi-plus-circle"></i> Include in Calculations
                                                        </button>
                                                    </form>
                                                </td>
                                            </tr>
                                        {% endif %}
                                    {% endfor %}
                                    {% if not has_excluded %}
                                        <tr>
                                            <td colspan="3" class="text-center">
                                                <em>No manually excluded students</em>
                                            </td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

{% if program_outcome_results and course_outcome_results %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    function exportResults() {
        // Get sorting parameters from sessionStorage
        const sortBy = sessionStorage.getItem('studentSortBy') || '';
        const sortDirection = sessionStorage.getItem('studentSortDirection') || '';
        
        // Add sorting parameters to the export URL
        let exportUrl = "{{ url_for('calculation.export_results', course_id=course.id) }}";
        if (sortBy && sortDirection) {
            exportUrl += `?sort_by=${sortBy}&sort_direction=${sortDirection}`;
        }
        
        window.location.href = exportUrl;
    }
    
    function exportStudentResults() {
        window.location.href = "{{ url_for('calculation.export_student_results', course_id=course.id) }}";
    }
    
    // Helper function to show alerts
    function showAlert(type, message) {
        var alertContainer = document.createElement('div');
        alertContainer.className = 'alert alert-' + type + ' alert-dismissible fade show position-fixed top-0 end-0 m-3';
        alertContainer.setAttribute('role', 'alert');
        alertContainer.innerHTML = message + 
            '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
        document.body.appendChild(alertContainer);
        
        // Remove alert after 3 seconds
        setTimeout(function() {
            alertContainer.remove();
        }, 3000);
    }
    
    // Function to refresh the student achievement data section
    function refreshStudentAchievementData() {
        // Get the course ID from the page URL
        var pathParts = window.location.pathname.split('/');
        var courseId = pathParts[pathParts.indexOf('course') + 1];
        
        // Get the student achievement data section
        var achievementDataSection = document.getElementById('studentAchievementDataSection');
        if (!achievementDataSection) return;
        
        // Show loading spinner in the section
        var loadingSpinner = document.createElement('div');
        loadingSpinner.className = 'text-center p-3';
        loadingSpinner.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Refreshing data...</p>';
        
        achievementDataSection.appendChild(loadingSpinner);
        
        // Fetch updated data via AJAX
        fetch(window.location.pathname, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            // Remove the loading spinner
            if (loadingSpinner.parentNode) {
                loadingSpinner.parentNode.removeChild(loadingSpinner);
            }
            
            // Get the student results table body
            var studentTableBody = document.querySelector('#studentResultsTable tbody');
            if (studentTableBody && data.student_results) {
                // Clear current table content
                studentTableBody.innerHTML = '';
                
                // Rebuild the table with updated data
                for (var studentId in data.student_results) {
                    var studentData = data.student_results[studentId];
                    
                    // Create the main student row
                    var row = document.createElement('tr');
                    
                    // Student ID cell
                    var idCell = document.createElement('td');
                    idCell.textContent = studentData.student_id;
                    row.appendChild(idCell);
                    
                    // Name cell with exclusion badge if needed
                    var nameCell = document.createElement('td');
                    nameCell.textContent = studentData.name;
                    if (studentData.excluded) {
                        nameCell.innerHTML += ' <span class="badge bg-danger rounded-pill"><i class="fas fa-ban me-1"></i>Excluded from Calculations</span>';
                    }
                    row.appendChild(nameCell);
                    
                    // Overall score cell
                    var scoreCell = document.createElement('td');
                    if (studentData.missing_mandatory) {
                        scoreCell.innerHTML = '<div class="alert alert-danger p-2 mb-0 d-flex align-items-center">' +
                            '<i class="fas fa-exclamation-triangle me-2"></i>' +
                            '<span>' +
                            (studentData.excluded ? '<strong>Manually Excluded</strong>' +
                                '<small class="d-block text-muted">' +
                                '<i class="fas fa-info-circle me-1"></i>Score calculations may be inaccurate' +
                                '</small>' : '<strong>Missed Mandatory Exam</strong>') +
                            '</span>' +
                            '</div>';
                    } else {
                        var achievement = getAchievementLevel(studentData.overall_percentage);
                        scoreCell.innerHTML = '<div class="progress" style="height: 25px;">' +
                            '<div class="progress-bar bg-' + achievement.color + '" ' +
                            'role="progressbar" ' +
                            'style="width: ' + studentData.overall_percentage + '%;" ' +
                            'aria-valuenow="' + studentData.overall_percentage + '" ' +
                            'aria-valuemin="0" ' +
                            'aria-valuemax="100">' +
                            studentData.overall_percentage.toFixed(1) + '% (' + achievement.name + ')' +
                            '</div>' +
                            '</div>';
                    }
                    row.appendChild(scoreCell);
                    
                    // Actions cell
                    var actionsCell = document.createElement('td');
                    actionsCell.innerHTML = '<button class="btn btn-sm btn-outline-info" type="button" ' +
                        'data-bs-toggle="collapse" ' +
                        'data-bs-target="#student' + studentId + 'Details" ' +
                        'aria-expanded="false" ' +
                        'aria-controls="student' + studentId + 'Details">' +
                        'Show Details' +
                        '</button>';
                    
                    if (!studentData.excluded) {
                        actionsCell.innerHTML += ' <button type="button" class="btn btn-sm btn-outline-warning exclude-btn" ' +
                            'data-student-id="' + studentId + '" ' +
                            'data-toggle-url="/student/' + studentId + '/toggle_exclusion" ' +
                            'data-student-name="' + studentData.name + '" ' +
                            'data-student-id-text="' + studentData.student_id + '">' +
                            '<i class="bi bi-dash-circle"></i> Exclude' +
                            '</button>';
                    }
                    row.appendChild(actionsCell);
                    
                    studentTableBody.appendChild(row);
                    
                    // Create the details row
                    var detailsRow = document.createElement('tr');
                    detailsRow.className = 'collapse';
                    detailsRow.id = 'student' + studentId + 'Details';
                    
                    var detailsCell = document.createElement('td');
                    detailsCell.colSpan = 4;
                    detailsCell.className = 'p-0';
                    
                    var detailsContent = document.createElement('div');
                    detailsContent.className = 'p-3 bg-light';
                    
                    // Course outcomes achievement
                    var coHtml = '<h6>Course Outcome Achievement for ' + studentData.name + '</h6>' +
                        '<div class="row">';
                    
                    for (var coCode in studentData.course_outcomes) {
                        var percentage = studentData.course_outcomes[coCode];
                        var coAchievement = getAchievementLevel(percentage);
                        
                        coHtml += '<div class="col-md-6 mb-2">' +
                            '<small><strong>' + coCode + ':</strong></small>' +
                            '<div class="progress" style="height: 15px;">' +
                            '<div class="progress-bar bg-' + coAchievement.color + '" ' +
                            'role="progressbar" ' +
                            'style="width: ' + percentage + '%;" ' +
                            'aria-valuenow="' + percentage + '" ' +
                            'aria-valuemin="0" ' +
                            'aria-valuemax="100">' +
                            percentage.toFixed(1) + '%' +
                            '</div>' +
                            '</div>' +
                            '</div>';
                    }
                    
                    coHtml += '</div>';
                    
                    // Exam scores
                    coHtml += '<h6 class="mt-3">Exam Scores</h6>' +
                        '<div class="row">';
                    
                    for (var examName in studentData.exam_scores) {
                        var percentage = studentData.exam_scores[examName];
                        var examAchievement = getAchievementLevel(percentage);
                        
                        coHtml += '<div class="col-md-6 mb-2">' +
                            '<small><strong>' + examName + ':</strong></small>' +
                            '<div class="progress" style="height: 15px;">' +
                            '<div class="progress-bar bg-' + examAchievement.color + '" ' +
                            'role="progressbar" ' +
                            'style="width: ' + percentage + '%;" ' +
                            'aria-valuenow="' + percentage + '" ' +
                            'aria-valuemin="0" ' +
                            'aria-valuemax="100">' +
                            percentage.toFixed(1) + '%' +
                            '</div>' +
                            '</div>' +
                            '</div>';
                    }
                    
                    coHtml += '</div>';
                    
                    detailsContent.innerHTML = coHtml;
                    detailsCell.appendChild(detailsContent);
                    detailsRow.appendChild(detailsCell);
                    
                    studentTableBody.appendChild(detailsRow);
                }
                
                // Reattach event listeners to the new exclude buttons
                document.querySelectorAll('.exclude-btn').forEach(function(excludeButton) {
                    excludeButton.addEventListener('click', handleExcludeButtonClick);
                });
            }
            
            // Update the excluded students section
            var excludedTable = document.querySelector('#excludedStudentsTable tbody');
            if (excludedTable && data.student_results) {
                // Clear current table content
                excludedTable.innerHTML = '';
                
                var hasExcluded = false;
                
                // Add rows for excluded students
                for (var studentId in data.student_results) {
                    var studentData = data.student_results[studentId];
                    
                    if (studentData.excluded) {
                        hasExcluded = true;
                        
                        var row = document.createElement('tr');
                        
                        // Student ID cell
                        var idCell = document.createElement('td');
                        idCell.textContent = studentData.student_id;
                        row.appendChild(idCell);
                        
                        // Name cell
                        var nameCell = document.createElement('td');
                        nameCell.textContent = studentData.name;
                        row.appendChild(nameCell);
                        
                        // Actions cell
                        var actionsCell = document.createElement('td');
                        actionsCell.innerHTML = '<form method="post" action="/student/' + studentId + '/toggle_exclusion" class="d-inline include-form">' +
                            '<button type="submit" class="btn btn-sm btn-success include-btn">' +
                            '<i class="bi bi-plus-circle"></i> Include in Calculations' +
                            '</button>' +
                            '</form>';
                        row.appendChild(actionsCell);
                        
                        excludedTable.appendChild(row);
                    }
                }
                
                // If no excluded students, show a message
                if (!hasExcluded) {
                    var emptyRow = document.createElement('tr');
                    emptyRow.innerHTML = '<td colspan="3" class="text-center"><em>No manually excluded students</em></td>';
                    excludedTable.appendChild(emptyRow);
                }
                
                // Reattach event listeners to the new include forms
                document.querySelectorAll('.include-form').forEach(function(form) {
                    form.addEventListener('submit', handleIncludeFormSubmit);
                });
            }
            
            // Update charts if they're available
            if (data.course_outcome_results && data.program_outcome_results) {
                updateCharts(data);
            }
        })
        .catch(function(error) {
            console.error('Error refreshing data:', error);
            // Remove the loading spinner
            if (loadingSpinner.parentNode) {
                loadingSpinner.parentNode.removeChild(loadingSpinner);
            }
            showAlert('danger', 'Error refreshing data. Please reload the page manually.');
        });
    }
    
    // Helper function to determine achievement level from percentage
    function getAchievementLevel(percentage) {
        // Default values in case achievement_levels isn't available
        var achievementLevels = window.achievementLevels || [
            { name: 'Excellent', min_score: 90, max_score: 100, color: 'success' },
            { name: 'Good', min_score: 70, max_score: 89.99, color: 'primary' },
            { name: 'Average', min_score: 60, max_score: 69.99, color: 'info' },
            { name: 'Below Average', min_score: 50, max_score: 59.99, color: 'warning' },
            { name: 'Poor', min_score: 0, max_score: 49.99, color: 'danger' }
        ];
        
        for (var i = 0; i < achievementLevels.length; i++) {
            var level = achievementLevels[i];
            if (percentage >= level.min_score && percentage <= level.max_score) {
                return level;
            }
        }
        
        // Default if no matching level is found
        return { name: 'N/A', color: 'secondary' };
    }
    
    // Store achievement levels from server in a global variable for use in JavaScript
    window.achievementLevels = [
        {% for level in achievement_levels %}
        {
            name: '{{ level.name }}',
            min_score: {{ level.min_score|float }},
            max_score: {{ level.max_score|float }},
            color: '{{ level.color }}'
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
    // Helper function to update charts if they exist
    function updateCharts(data) {
        // This would need to be expanded with the actual chart update code
        // based on Chart.js specifics and your existing chart initialization
        console.log('Charts would be updated with new data');
    }
    
    // Function to handle exclude button clicks
    function handleExcludeButtonClick(e) {
        e.preventDefault();
        
        var thisButton = this;
        var studentId = thisButton.getAttribute('data-student-id');
        var toggleUrl = thisButton.getAttribute('data-toggle-url');
        var studentName = thisButton.getAttribute('data-student-name');
        var studentIdText = thisButton.getAttribute('data-student-id-text');
        var originalContent = thisButton.innerHTML;
        
        // Show a spinner while processing
        thisButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
        thisButton.disabled = true;
        
        // Submit the request via AJAX
        fetch(toggleUrl, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json'
            }
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            if (data.success) {
                // Find the parent row
                var currentRow = thisButton.closest('tr');
                
                // Add the "Excluded from Calculations" badge to the name cell
                var nameCell = currentRow.querySelector('td:nth-child(2)');
                var nameText = nameCell.textContent.trim();
                nameCell.innerHTML = nameText + 
                    ' <span class="badge bg-danger rounded-pill"><i class="fas fa-ban me-1"></i>Excluded from Calculations</span>';
                
                // Update the action cell - remove the exclude button
                var actionCell = thisButton.closest('td');
                actionCell.removeChild(thisButton);
                
                // Show success message
                showAlert('success', data.message);
                
                // Refresh the student achievement data section
                refreshStudentAchievementData();
            } else {
                // Restore original button content on error
                thisButton.innerHTML = originalContent;
                thisButton.disabled = false;
                
                // Show error message
                showAlert('danger', 'Error: ' + data.message);
            }
        })
        .catch(function(error) {
            console.error('Error:', error);
            thisButton.innerHTML = originalContent;
            thisButton.disabled = false;
            
            // Show error message
            showAlert('danger', 'An error occurred while processing your request.');
        });
    }
    
    // Function to handle include form submissions
    function handleIncludeFormSubmit(e) {
        e.preventDefault();
        var form = this;
        var submitButton = form.querySelector('.include-btn');
        var originalContent = submitButton.innerHTML;
        
        // Show a spinner while processing
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
        submitButton.disabled = true;
        
        // Submit the form via AJAX
        fetch(form.action, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json'
            }
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            if (data.success) {
                // Remove the row since the student is no longer excluded
                var row = form.closest('tr');
                row.remove();
                
                // Show success message
                showAlert('success', data.message);
                
                // Refresh the student achievement data section
                refreshStudentAchievementData();
                
                // If there are no more excluded students, show the "No manually excluded students" message
                var excludedTable = document.querySelector('#excludedStudentsTable tbody');
                if (excludedTable && excludedTable.querySelectorAll('tr').length === 0) {
                    var emptyRow = document.createElement('tr');
                    emptyRow.innerHTML = '<td colspan="3" class="text-center"><em>No manually excluded students</em></td>';
                    excludedTable.appendChild(emptyRow);
                }
            } else {
                // Show error message
                showAlert('danger', 'Error: ' + data.message);
                
                // Restore original button content
                submitButton.innerHTML = originalContent;
                submitButton.disabled = false;
            }
        })
        .catch(function(error) {
            console.error('Error:', error);
            submitButton.innerHTML = originalContent;
            submitButton.disabled = false;
            showAlert('danger', 'An error occurred while processing your request.');
        });
    }
    
    // Add event listeners when the DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Handle "Include in Calculations" forms via AJAX
        document.querySelectorAll('.include-form').forEach(function(form) {
            form.addEventListener('submit', handleIncludeFormSubmit);
        });
        
        // Handle "Exclude" buttons via AJAX
        document.querySelectorAll('.exclude-btn').forEach(function(excludeButton) {
            excludeButton.addEventListener('click', handleExcludeButtonClick);
        });
        
        console.log("DOM loaded, initializing charts directly");
        
        // Program Outcomes Chart
        const poChart = document.getElementById('programOutcomesChart');
        if (poChart && typeof Chart !== 'undefined') {
            try {
                const poCtx = poChart.getContext('2d');
                new Chart(poCtx, {
                    type: 'bar',
                    data: {
                        labels: [{% for po_code in program_outcome_results %}'{{ po_code }}',{% endfor %}],
                        datasets: [{
                            label: 'Achievement Level (%)',
                            data: [
                                {% for po_code, po_data in program_outcome_results.items() %}
                                {% set percentage = po_data.percentage|float if po_data.percentage is not none else 0 %}
                                {{ percentage }},
                                {% endfor %}
                            ],
                            backgroundColor: [
                                {% for po_code, po_data in program_outcome_results.items() %}
                                {% set percentage = po_data.percentage|float if po_data.percentage is not none else 0 %}
                                '{% if po_data.achievement_level %}rgba({% if po_data.achievement_level.color == "primary" %}13, 110, 253{% elif po_data.achievement_level.color == "secondary" %}108, 117, 125{% elif po_data.achievement_level.color == "success" %}25, 135, 84{% elif po_data.achievement_level.color == "danger" %}220, 53, 69{% elif po_data.achievement_level.color == "warning" %}255, 193, 7{% elif po_data.achievement_level.color == "info" %}13, 202, 240{% elif po_data.achievement_level.color == "dark" %}33, 37, 41{% else %}108, 117, 125{% endif %}, 0.7){% else %}rgba(108, 117, 125, 0.7){% endif %}',
                                {% endfor %}
                            ],
                            borderColor: [
                                {% for po_code, po_data in program_outcome_results.items() %}
                                {% set percentage = po_data.percentage|float if po_data.percentage is not none else 0 %}
                                '{% if po_data.achievement_level %}rgba({% if po_data.achievement_level.color == "primary" %}13, 110, 253{% elif po_data.achievement_level.color == "secondary" %}108, 117, 125{% elif po_data.achievement_level.color == "success" %}25, 135, 84{% elif po_data.achievement_level.color == "danger" %}220, 53, 69{% elif po_data.achievement_level.color == "warning" %}255, 193, 7{% elif po_data.achievement_level.color == "info" %}13, 202, 240{% elif po_data.achievement_level.color == "dark" %}33, 37, 41{% else %}108, 117, 125{% endif %}, 1){% else %}rgba(108, 117, 125, 1){% endif %}',
                                {% endfor %}
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Achievement Level (%)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Program Outcomes'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Program Outcome Achievement Levels',
                                font: { size: 16 }
                            }
                        }
                    }
                });
                console.log("Program outcomes chart created");
            } catch (error) {
                console.error("Error creating program outcomes chart:", error);
                const errorMsg = document.createElement('div');
                errorMsg.className = 'alert alert-danger';
                errorMsg.innerHTML = '<strong>Error:</strong> Failed to create chart: ' + error.message;
                poChart.parentNode.insertBefore(errorMsg, poChart);
            }
        }
        
        // Course Outcomes Chart
        const coChart = document.getElementById('courseOutcomesChart');
        if (coChart && typeof Chart !== 'undefined') {
            try {
                const coCtx = coChart.getContext('2d');
                new Chart(coCtx, {
                    type: 'bar',
                    data: {
                        labels: [{% for co_code in course_outcome_results %}'{{ co_code }}',{% endfor %}],
                        datasets: [{
                            label: 'Achievement Level (%)',
                            data: [
                                {% for co_code, co_data in course_outcome_results.items() %}
                                {% set percentage = co_data.percentage|float if co_data.percentage is not none else 0 %}
                                {{ percentage }},
                                {% endfor %}
                            ],
                            backgroundColor: [
                                {% for co_code, co_data in course_outcome_results.items() %}
                                {% set percentage = co_data.percentage|float if co_data.percentage is not none else 0 %}
                                '{% if co_data.achievement_level %}rgba({% if co_data.achievement_level.color == "primary" %}13, 110, 253{% elif co_data.achievement_level.color == "secondary" %}108, 117, 125{% elif co_data.achievement_level.color == "success" %}25, 135, 84{% elif co_data.achievement_level.color == "danger" %}220, 53, 69{% elif co_data.achievement_level.color == "warning" %}255, 193, 7{% elif co_data.achievement_level.color == "info" %}13, 202, 240{% elif co_data.achievement_level.color == "dark" %}33, 37, 41{% else %}108, 117, 125{% endif %}, 0.7){% else %}rgba(108, 117, 125, 0.7){% endif %}',
                                {% endfor %}
                            ],
                            borderColor: [
                                {% for co_code, co_data in course_outcome_results.items() %}
                                {% set percentage = co_data.percentage|float if co_data.percentage is not none else 0 %}
                                '{% if co_data.achievement_level %}rgba({% if co_data.achievement_level.color == "primary" %}13, 110, 253{% elif co_data.achievement_level.color == "secondary" %}108, 117, 125{% elif co_data.achievement_level.color == "success" %}25, 135, 84{% elif co_data.achievement_level.color == "danger" %}220, 53, 69{% elif co_data.achievement_level.color == "warning" %}255, 193, 7{% elif co_data.achievement_level.color == "info" %}13, 202, 240{% elif co_data.achievement_level.color == "dark" %}33, 37, 41{% else %}108, 117, 125{% endif %}, 1){% else %}rgba(108, 117, 125, 1){% endif %}',
                                {% endfor %}
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Achievement Level (%)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Course Outcomes'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Course Outcome Achievement Levels',
                                font: { size: 16 }
                            }
                        }
                    }
                });
                console.log("Course outcomes chart created");
            } catch (error) {
                console.error("Error creating course outcomes chart:", error);
                const errorMsg = document.createElement('div');
                errorMsg.className = 'alert alert-danger';
                errorMsg.innerHTML = '<strong>Error:</strong> Failed to create chart: ' + error.message;
                coChart.parentNode.insertBefore(errorMsg, coChart);
            }
        }
        
        // Student search functionality
        const searchInput = document.getElementById('studentSearch');
        const table = document.getElementById('studentResultsTable');
        
        if (searchInput && table) {
            searchInput.addEventListener('keyup', function() {
                const searchTerm = this.value.toLowerCase();
                const rows = table.querySelectorAll('tbody tr:not(.collapse)');
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    const studentId = row.id ? row.id : row.querySelector('td:first-child').textContent;
                    const detailsRow = document.getElementById(`student${studentId}Details`);
                    
                    if (text.includes(searchTerm)) {
                        row.style.display = '';
                        if (detailsRow) detailsRow.style.display = '';
                    } else {
                        row.style.display = 'none';
                        if (detailsRow) detailsRow.style.display = 'none';
                    }
                });
            });
        }
        
        // Student sorting functionality
        let currentSort = null;
        let currentDirection = 'asc';
        
        // Add click event to sort buttons in the sort panel
        const sortButtons = document.querySelectorAll('.sort-btn');
        if (sortButtons && table) {
            sortButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const sortBy = this.getAttribute('data-sort');
                    const direction = this.getAttribute('data-direction');
                    
                    // Update current sort state
                    currentSort = sortBy;
                    currentDirection = direction;
                    
                    // Update UI to show active sort button
                    sortButtons.forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Update sort icons in the table headers
                    const sortableHeaders = document.querySelectorAll('.sortable');
                    sortableHeaders.forEach(h => {
                        const icon = h.querySelector('i');
                        if (h.getAttribute('data-sort') === currentSort) {
                            icon.className = currentDirection === 'asc' ? 
                                'fas fa-sort-up ms-1' : 'fas fa-sort-down ms-1';
                        } else {
                            icon.className = 'fas fa-sort ms-1';
                        }
                    });
                    
                    // Sort the rows
                    sortStudentTable(sortBy, direction);
                });
            });
        }
        
        // Add click event to sortable headers
        const sortableHeaders = document.querySelectorAll('.sortable');
        if (sortableHeaders && table) {
            sortableHeaders.forEach(header => {
                header.addEventListener('click', function() {
                    const sortBy = this.getAttribute('data-sort');
                    
                    // Toggle direction if same column clicked again
                    if (currentSort === sortBy) {
                        currentDirection = currentDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort = sortBy;
                        currentDirection = 'asc';
                    }
                    
                    // Update sort buttons in the sort panel
                    sortButtons.forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.getAttribute('data-sort') === currentSort && 
                            btn.getAttribute('data-direction') === currentDirection) {
                            btn.classList.add('active');
                        }
                    });
                    
                    // Update sort icons in all headers
                    sortableHeaders.forEach(h => {
                        const icon = h.querySelector('i');
                        if (h.getAttribute('data-sort') === currentSort) {
                            icon.className = currentDirection === 'asc' ? 
                                'fas fa-sort-up ms-1' : 'fas fa-sort-down ms-1';
                        } else {
                            icon.className = 'fas fa-sort ms-1';
                        }
                    });
                    
                    // Sort the rows
                    sortStudentTable(sortBy, currentDirection);
                });
            });
        }
        
        function sortStudentTable(sortBy, direction) {
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr:not(.collapse)'));
            
            // Save the details rows associated with each student row
            const detailsMap = {};
            rows.forEach(row => {
                const studentId = row.querySelector('td:first-child').textContent.trim();
                // Get the actual student ID from the data
                const studentIdInData = studentId.split(' ')[0]; // Handle any badges/text after ID
                // Find the associated details row - it's the next sibling that has class 'collapse'
                const detailsRow = Array.from(tbody.querySelectorAll('tr.collapse')).find(r => 
                    r.id.includes(studentIdInData) || r.id.includes(row.cells[0].textContent.trim())
                );
                if (detailsRow) {
                    detailsMap[studentId] = detailsRow;
                }
            });
            
            // Sort the rows
            rows.sort((a, b) => {
                let valA, valB;
                
                if (sortBy === 'student_id') {
                    valA = a.querySelector('td:nth-child(1)').textContent.trim();
                    valB = b.querySelector('td:nth-child(1)').textContent.trim();
                } else if (sortBy === 'name') {
                    valA = a.querySelector('td:nth-child(2)').textContent.trim();
                    valB = b.querySelector('td:nth-child(2)').textContent.trim();
                } else if (sortBy === 'overall_score') {
                    const scoreA = a.querySelector('td:nth-child(3) .progress-bar');
                    const scoreB = b.querySelector('td:nth-child(3) .progress-bar');
                    valA = scoreA ? parseFloat(scoreA.getAttribute('aria-valuenow')) : -1;
                    valB = scoreB ? parseFloat(scoreB.getAttribute('aria-valuenow')) : -1;
                }
                
                if (typeof valA === 'string' && typeof valB === 'string') {
                    return direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                } else {
                    return direction === 'asc' ? valA - valB : valB - valA;
                }
            });
            
            // Remove all rows from the table
            rows.forEach(row => row.remove());
            Object.values(detailsMap).forEach(row => row.remove());
            
            // Add the sorted rows back
            rows.forEach(row => {
                const studentId = row.querySelector('td:first-child').textContent.trim();
                tbody.appendChild(row);
                if (detailsMap[studentId]) {
                    tbody.appendChild(detailsMap[studentId]);
                }
            });
            
            // Store sort settings in sessionStorage for export
            sessionStorage.setItem('studentSortBy', sortBy);
            sessionStorage.setItem('studentSortDirection', direction);
        }
    });
</script>
{% endif %}
{% endblock %} 