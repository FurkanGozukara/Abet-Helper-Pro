{% extends 'base.html' %}

{% block title %}Batch Add Questions - {{ exam.name }} - ABET Calculator{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('course.course_detail', course_id=course.id) }}">{{ course.code }}</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('exam.exam_detail', exam_id=exam.id) }}">{{ exam.name }}</a></li>
<li class="breadcrumb-item active">Batch Add Questions</li>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="card">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h4 class="mb-0">Batch Add Questions to: {{ exam.name }} ({{ course.code }})</h4>
            <a href="{{ url_for('exam.exam_detail', exam_id=exam.id) }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Exam
            </a>
        </div>
        <div class="card-body">
            <div class="alert alert-info mb-4">
                <i class="fas fa-info-circle"></i> 
                Add multiple questions at once. Set the maximum score for each question and select relevant course outcomes.
            </div>
            
            <div id="save-status" class="alert alert-success" style="display: none;">
                <i class="fas fa-check-circle"></i> Changes saved successfully
            </div>
            
            <form method="POST" id="questionForm">
                <div class="mb-3">
                    <label for="num_questions" class="form-label">Number of Questions:</label>
                    <div class="input-group">
                        <input type="number" id="num_questions" name="num_questions" class="form-control" 
                               value="{{ num_questions }}" min="1" max="100">
                        <button type="button" id="update_num" class="btn btn-outline-primary">
                            <i class="fas fa-sync-alt"></i> Update
                        </button>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-striped table-bordered" id="questionsTable">
                        <thead class="thead-light">
                            <tr>
                                <th width="5%">No.</th>
                                <th width="40%">Question Text</th>
                                <th width="10%">Max Points</th>
                                <th width="45%">Course Outcomes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for i in range(num_questions) %}
                                <tr>
                                    <td>{{ i + 1 }}</td>
                                    <td>
                                        <input type="text" name="text_{{ i }}" class="form-control question-field" 
                                               data-index="{{ i }}" placeholder="Question text (optional)">
                                    </td>
                                    <td>
                                        <input type="number" name="max_score_{{ i }}" class="form-control question-field" 
                                               data-index="{{ i }}" value="1" min="0.5" step="0.5" required>
                                    </td>
                                    <td>
                                        <div class="outcome-checkboxes">
                                            {% for outcome in course_outcomes %}
                                                <div class="form-check">
                                                    <input class="form-check-input outcome-checkbox" type="checkbox" 
                                                           name="course_outcomes_{{ i }}" value="{{ outcome.id }}" 
                                                           id="outcome_{{ i }}_{{ outcome.id }}" data-index="{{ i }}">
                                                    <label class="form-check-label" for="outcome_{{ i }}_{{ outcome.id }}">
                                                        <strong>{{ outcome.code }}</strong>: {{ outcome.description|truncate(50) }}
                                                    </label>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="d-flex justify-content-between mt-4">
                    <a href="{{ url_for('exam.exam_detail', exam_id=exam.id) }}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save All Questions
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Update number of questions
        document.getElementById('update_num').addEventListener('click', function() {
            const numQuestions = parseInt(document.getElementById('num_questions').value) || 1;
            if (numQuestions > 0 && numQuestions <= 100) {
                window.location.href = "{{ url_for('question.batch_add_questions', exam_id=exam.id) }}?num_questions=" + numQuestions;
            } else {
                alert('Please enter a valid number between 1 and 100');
            }
        });
        
        // Styles for outcome checkboxes
        const style = document.createElement('style');
        style.textContent = `
            .outcome-checkboxes {
                max-height: none;
                overflow-y: visible;
                padding: 8px;
                border: 1px solid #dee2e6;
                border-radius: 4px;
                background-color: #f8f9fa;
            }
            .form-check {
                margin-bottom: 6px;
                padding: 6px 10px;
                border-radius: 4px;
                transition: all 0.2s ease;
                border-left: 3px solid transparent;
            }
            .form-check:hover {
                background-color: #e9ecef;
            }
            .form-check-input {
                width: 18px;
                height: 18px;
                margin-top: 3px;
                cursor: pointer;
            }
            .form-check-input:checked {
                background-color: #0d6efd;
                border-color: #0d6efd;
            }
            .form-check-input:checked + .form-check-label {
                font-weight: 500;
                color: #0d6efd;
            }
            .form-check-label {
                cursor: pointer;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                display: inline-block;
                max-width: 100%;
                padding-left: 4px;
                transition: all 0.2s ease;
            }
            .form-check-label strong {
                transition: color 0.2s ease;
            }
        `;
        document.head.appendChild(style);
        
        // Update checkbox styles dynamically
        document.querySelectorAll('.outcome-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const label = this.nextElementSibling;
                const checkboxContainer = this.closest('.form-check');
                
                if (this.checked) {
                    checkboxContainer.style.backgroundColor = '#e8f0fe';
                    checkboxContainer.style.borderLeftColor = '#0d6efd';
                } else {
                    checkboxContainer.style.backgroundColor = '';
                    checkboxContainer.style.borderLeftColor = 'transparent';
                }
            });
        });
        
        // Add tooltips for long descriptions
        document.querySelectorAll('.form-check-label').forEach(label => {
            const fullText = label.innerText;
            label.setAttribute('title', fullText);
        });
        
        // Auto-save functionality
        const questionFields = document.querySelectorAll('.question-field');
        const outcomeCheckboxes = document.querySelectorAll('.outcome-checkbox');
        const saveStatusElement = document.getElementById('save-status');
        const totalQuestions = {{ num_questions }};
        
        // Helper function to show save status
        function showSaveStatus() {
            saveStatusElement.style.display = 'block';
            setTimeout(() => {
                saveStatusElement.style.display = 'none';
            }, 3000);
        }
        
        // Auto-save when question fields change
        questionFields.forEach(field => {
            field.addEventListener('change', function() {
                const index = this.dataset.index;
                const questionData = {
                    index: index,
                    text: document.querySelector(`input[name="text_${index}"]`).value,
                    max_score: document.querySelector(`input[name="max_score_${index}"]`).value,
                };
                
                // Store in session storage
                sessionStorage.setItem(`question_${index}`, JSON.stringify(questionData));
                showSaveStatus();
            });
        });
        
        // Auto-save when outcome checkboxes change
        outcomeCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const index = this.dataset.index;
                const outcomes = [];
                
                // Get all selected outcomes for this question
                document.querySelectorAll(`input[name="course_outcomes_${index}"]:checked`).forEach(cb => {
                    outcomes.push(cb.value);
                });
                
                // Store in session storage
                sessionStorage.setItem(`outcomes_${index}`, JSON.stringify(outcomes));
                showSaveStatus();
            });
        });
        
        // Load saved data on page load
        for (let i = 0; i < totalQuestions; i++) {
            const questionData = sessionStorage.getItem(`question_${i}`);
            const outcomesData = sessionStorage.getItem(`outcomes_${i}`);
            
            if (questionData) {
                const data = JSON.parse(questionData);
                document.querySelector(`input[name="text_${i}"]`).value = data.text || '';
                document.querySelector(`input[name="max_score_${i}"]`).value = data.max_score || 1;
            }
            
            if (outcomesData) {
                const outcomes = JSON.parse(outcomesData);
                outcomes.forEach(outcomeId => {
                    const checkbox = document.getElementById(`outcome_${i}_${outcomeId}`);
                    if (checkbox) {
                        checkbox.checked = true;
                        // Apply styles for selected checkbox
                        const checkboxContainer = checkbox.closest('.form-check');
                        if (checkboxContainer) {
                            checkboxContainer.style.backgroundColor = '#e8f0fe';
                            checkboxContainer.style.borderLeftColor = '#0d6efd';
                        }
                    }
                });
            }
        }
    });
</script>
{% endblock %} 